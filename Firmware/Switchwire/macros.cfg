##===========================================================================
##=========================== Macros Configuration ==========================
##===========================================================================
    # This file provides examples of Klipper G-Code macros.  The snippets
    # in this file may be copied into the main printer.cfg file and
    # customized.

    # See docs/Config_Reference.md for a description of parameters.
##=================================== End ===================================

##===========================================================================
##============================= Filament Profile ============================
##===========================================================================
[gcode_macro FILAMENT_PROFILE]
gcode:
##----------------------------------- PLA -----------------------------------
    {% if params.TYPE|default("Stock") == "PLA" %}
        TEXT MSG="Set filament profile : PLA" OUTPUT_TARGET=1
        # Set feed rate
        M220 S100
        # Set extrusion rate
        M221 S100
        # Set pressure advance
        SET_PRESSURE_ADVANCE ADVANCE=0.0
        # Set SCV limit
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5.0
##----------------------------------- PLA+ ----------------------------------
    {% elif params.TYPE|default("Stock") == "PLA+" %}
        TEXT MSG="Set filament profile : PLA+" OUTPUT_TARGET=1
        # Set feed rate
        M220 S100
        # Set extrusion rate
        M221 S100
        # Set pressure advance
        SET_PRESSURE_ADVANCE ADVANCE=0.0
        # Set SCV limit
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5.0
##----------------------------------- PETG ----------------------------------
    {% elif params.TYPE|default("Stock") == "PETG" %}
        TEXT MSG="Set filament profile : PETG" OUTPUT_TARGET=1
        # Set feed rate
        M220 S100
        # Set extrusion rate
        M221 S100
        # Set pressure advance
        SET_PRESSURE_ADVANCE ADVANCE=0.0
        # Set SCV limit
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5.0
##----------------------------------- ABS -----------------------------------
    {% elif params.TYPE|default("Stock") == "ABS" %}
        TEXT MSG="Set filament profile : ABS+" OUTPUT_TARGET=1
        # Set feed rate
        M220 S100
        # Set extrusion rate
        M221 S100
        # Set pressure advance
        SET_PRESSURE_ADVANCE ADVANCE=0.035
        # Set SCV limit
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=4.0
##----------------------------------- ABS+ ----------------------------------
    {% elif params.TYPE|default("Stock") == "ABS+" %}
        TEXT MSG="Set filament profile : ABS" OUTPUT_TARGET=1
        # Set feed rate
        M220 S100
        # Set extrusion rate
        M221 S100
        # Set pressure advance
        SET_PRESSURE_ADVANCE ADVANCE=0.035
        # Set SCV limit
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=4.0
##----------------------------------- ASA -----------------------------------
    {% elif params.TYPE|default("Stock") == "ASA" %}
        TEXT MSG="Set filament profile : ASA" OUTPUT_TARGET=1
        # Set feed rate
        M220 S100
        # Set extrusion rate
        M221 S100
        # Set pressure advance
        SET_PRESSURE_ADVANCE ADVANCE=0.0
        # Set SCV limit
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5.0
##---------------------------------- PA6-CF ---------------------------------
    {% elif params.TYPE|default("Stock") == "PA6-CF" %}
        TEXT MSG="Set filament profile : PA6-CF" OUTPUT_TARGET=1
        # Set feed rate
        M220 S100
        # Set extrusion rate
        M221 S100
        # Set pressure advance
        SET_PRESSURE_ADVANCE ADVANCE=0.0
        # Set SCV limit
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5.0
##--------------------------------- PA12-CF ---------------------------------
    {% elif params.TYPE|default("Stock") == "PA12-CF" %}
        TEXT MSG="Set filament profile : PA12-CF" OUTPUT_TARGET=1
        # Set feed rate
        M220 S100
        # Set extrusion rate
        M221 S100
        # Set pressure advance
        SET_PRESSURE_ADVANCE ADVANCE=0.0
        # Set SCV limit
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5.0
##---------------------------------- Stock ----------------------------------
    {% elif params.TYPE|default("Stock") == "Stock" %}
        TEXT MSG="Set filament profile : Stock" OUTPUT_TARGET=1
        # Set feed rate
        M220 S100
        # Set extrusion rate
        M221 S100
        # Set pressure advance
        SET_PRESSURE_ADVANCE ADVANCE=0.0
        # Set SCV limit
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5.0
##--------------------------------- Default ---------------------------------
    {% else %}
        TEXT MSG="Set filament profile : Default" OUTPUT_TARGET=1
        # Set feed rate
        M220 S100
        # Set extrusion rate
        M221 S100
        # Set pressure advance
        SET_PRESSURE_ADVANCE ADVANCE=0.0
        # Set SCV limit
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5.0
    {% endif %}
##=================================== End ===================================

##===========================================================================
##====================== Pause, Resume, Filament Change =====================
##===========================================================================
    # M600: Filament Change. This macro will pause the printer, move the
    # tool to the change position, and retract the filament 50mm. Adjust
    # the retraction settings for your own extruder. After filament has
    # been changed, the print can be resumed from its previous position
    # with the "RESUME" gcode.
##===========================================================================
[pause_resume]
##===========================================================================
##=============================== Pause Print ===============================
##===========================================================================
[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
# Change this if you need more or less extrusion
variable_extrude: 1.0
gcode:
    # Read extruder from pause macro
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    # Set park positon for X and Y
    # Default is your max posion from your printer.cfg
    {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
    {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
    # Calculate save lift position
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% if act_z < (max_z - 2.0) %}
        {% set z_safe = 2.0 %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
##---------------------------------------------------------------------------
    PAUSE_BASE
    # Set relative coordinate
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
        # Retract extruder
        G1 E-{E} F3600
    {% else %}
        {action_respond_info("Extruder not hot enough")}
    {% endif %}
    {% if "xyz" in printer.toolhead.homed_axes %}
        # Move Z
        G1 Z{z_safe} F1200
        # Set absolute coordinate
        G90
        # Move X, Y
        G1 X{x_park} Y{y_park} F9000
    {% else %}
        {action_respond_info("Printer not homed")}
    {% endif %} 
##=================================== End ===================================

##===========================================================================
##=============================== Resume Print ===============================
##===========================================================================
[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
    # Read extruder from pause macro 
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    # Get velocity parameter if specified
    {% if 'VELOCITY' in params|upper %}
        {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
    {%else %}
        {% set get_params = "" %}
    {% endif %}
    {% if printer.extruder.can_extrude|lower == 'true' %}
        # Set relative coordinate
        G91
        # Extrude filament
        G1 E{E} F3600
    {% else %}
        {action_respond_info("Extruder not hot enough")}
    {% endif %}  
    RESUME_BASE {get_params}
##=================================== End ===================================

##===========================================================================
##============================== Load Filament ==============================
##===========================================================================
[gcode_macro FILAMENT_LOAD]
gcode:
    SAVE_GCODE_STATE NAME=loading_filament
    PRINT MSG="Loading Filament"
    # Set relative extrusion distance
    M83
    # Reset extruder
    G92 E0
    # Check temperature
    MIN_TEMP_CHECK
    # Slow extrude filament
    G1 E{params.FEED_LENGTH|default(10)|int} F60
    # Reset extruder distance
    G92 E0.0
    # Fast extrude filament
    G1 E{params.FAST_LOAD_LENGTH|default(50)|int} F2000
    # Reset extruder distance
    G92 E0.0
    # Slow extrude filament
    G1 E{params.SLOW_LOAD_LENGTH|default(50)|int} F60       # Slow load to nozzle
    G92 E0
    # Set absolute coordinate
    G90
    PRINT MSG="Ready"
    RESTORE_GCODE_STATE NAME=loading_filament
##=================================== End ===================================

##===========================================================================
##============================= Unload Filament =============================
##===========================================================================
[gcode_macro FILAMENT_UNLOAD]
gcode:
    SAVE_GCODE_STATE NAME=unloading_filament
    PRINT MSG="Unloading Filament"
    # Set relative extrusion distance
    M83
    # Reset extruder
    G92 E0
    MIN_TEMP_CHECK
    G1 E{params.FEED_LENGTH|default(10)|int} F100 
    G92 E0.0
    G1 E-{params.FAST_UNLOAD_LENGTH|default(70)|int} F2000  # fast unload
    G92 E0.0
    G1 E-{params.SLOW_UNLOAD_LENGTH|default(40)|int} F1000  # slow unload
    G92 E0.0
    # Set absolute coordinate
    G90
    PRINT MSG="Ready"
    RESTORE_GCODE_STATE NAME=unloading_filament
##=================================== End ===================================

##===========================================================================
##========================== SDCard Looping / M808 ==========================
##===========================================================================
## Support SDCard looping
[sdcard_loop]
##---------------------------------------------------------------------------
[gcode_macro M808]
gcode:
    {% if params.K is not defined and params.L is defined %}
        SDCARD_LOOP_BEGIN COUNT={params.L|int}
    {% endif %}
    {% if params.K is not defined and params.L is not defined %}
        SDCARD_LOOP_END
    {% endif %}
    {% if params.K is defined and params.L is not defined %}
        SDCARD_LOOP_DESIST
    {% endif %}
##=================================== End ===================================

##===========================================================================
##=============================== Custom Text ===============================
##===========================================================================
# OUTPUT_TARGET 0 : Both LCD and terminal , 1 : Terminal only , 2 : LCD only
[gcode_macro TEXT]
variable_parameter_MSG : ''
variable_parameter_OUTPUT_TARGET : 0
gcode:
    {% if params.OUTPUT_TARGET|default(0)|int == 0 %}
        M117 {params.MSG | string}
        {action_respond_info((params.MSG) | string)}
    {% elif params.OUTPUT_TARGET|default(0)|int == 1 %}
        {action_respond_info((params.MSG) | string)}
    {% else %}
        M117 {params.MSG | string}
    {% endif %}
##=================================== End ===================================

##===========================================================================
##============================= Turn Off Printer ============================
##===========================================================================
[gcode_macro TURN_OFF_PRINTER]
gcode:
    TEXT MSG="Reset" OUTPUT_TARGET=1
    # Unit to milimeters
    G21
    # Set absolute coordinate
    G90
    # Clears paused state
    CLEAR_PAUSE
    # Clear mesh
    BED_MESH_CLEAR
    # Turn off heaters
    TURN_OFF_HEATERS
    # Turn off stepper motors
    MOTORS_OFF
    # Turn off fan
    M107
    # Reset speed factor percentage
    M220 S100
    # Reset extrude factor percentage
    M221 S100
    # Reset extruder distance
    G92 E0
    # Reset printer maximum velocity
    SET_VELOCITY_LIMIT VELOCITY=200
    # Reset printer maximum acceleration
    SET_VELOCITY_LIMIT ACCEL=1000
    # Reset printer maximum deceleration
    SET_VELOCITY_LIMIT ACCEL_TO_DECEL=500
    # Reset printer square corner velocity
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5.0
##------------------------------- Idle Timeout ------------------------------
[idle_timeout]
gcode:
    TURN_OFF_PRINTER
timeout: 300
##------------------------------- Turn Off PSU ------------------------------
[delayed_gcode TURN_OFF_PSU]
initial_duration: 0.
gcode:
    {% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
        {% if printer.extruder.temperature < 50 %}
            TURN_OFF_PRINTER
            {action_call_remote_method("set_device_power", device="PSU", state="off")}
        {% else %}
            UPDATE_DELAYED_GCODE ID=TURN_OFF_PSU DURATION=300
        {% endif %}
    {% endif %}
##=================================== End ===================================

##===========================================================================
##============================== Motor Commands =============================
##===========================================================================
##================================ Motors On ================================
[gcode_macro MOTORS_ON]
gcode:
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
    SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1
##=================================== End ===================================

##================================ Motors Off ===============================
[gcode_macro MOTORS_OFF]
gcode:
    M84
##=================================== End ===================================

##===========================================================================
##=============================== Probe Debug ===============================
##===========================================================================
##================================= Pin Down ================================
[gcode_macro PROBE_PIN_DOWN]
gcode:
    BLTOUCH_DEBUG COMMAND=pin_down
##=================================== End ===================================

##================================== Pin Up =================================
[gcode_macro PROBE_PIN_UP]
gcode:
    BLTOUCH_DEBUG COMMAND=pin_up
##=================================== End ===================================

##================================ Self Test ================================
[gcode_macro PROBE_TEST]
gcode:
    BLTOUCH_DEBUG COMMAND=self_test
    G4 P10000
    BLTOUCH_DEBUG COMMAND=reset
##=================================== End ===================================

##================================== Reset ==================================
[gcode_macro PROBE_RESET]
gcode:
    BLTOUCH_DEBUG COMMAND=reset
##=================================== End ===================================

##============================ Probe Calibration ============================
[gcode_macro PROBE_CALIBRATION]
gcode:
    G28
    PROBE_CALIBRATE
##=================================== End ===================================

##============================== Probe Accuracy =============================
[gcode_macro PROBE_TEST_ACCURACY]
gcode:
    G28
    PROBE_ACCURACY SAMPLES=10
##=================================== End ===================================

##============================ Probe Test Offset ============================
[gcode_macro PROBE_OFFSET]
gcode:
    G28
    G1 X90 Y110 F3000
    G1 Z0 F120
##=================================== End ===================================