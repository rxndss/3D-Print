##===========================================================================
##========================== Printer Configuration ==========================
##============================== VORON, V2.4r2 ==============================
##===========================================================================
    # This file contains common pin mappings for the BIGTREETECH Octopus Pro
    # V1.0. To use this config, the firmware should be compiled for the
    # STM32F446.

    # See docs/Config_Reference.md for a description of parameters.

    # The "make flash" command does not work on the Octopus V1.1. Instead,
    # after running "make", copy the generated "out/klipper.bin" file to a
    # file named "firmware.bin" on an SD card and then restart the Octopus 
    # Pro V1.0 with SD card.
    ##---------------------------------------------------------------------##
    # sudo apt install make
    # cd ~/klipper
    # make clean
    # make menuconfig
        # [V] Enable extra low-level
        # Micro-controller architecture : STMicroelectronics STM32
        # Processor : STM32F446
        # Bootloader : 32KiB bootloader
        # Clock Reference : 12 MHz crystal
        # Connection : USB (on PA11/PA12)
        # [Q] - Save and Exit
    # make
    # cd ~/klipper
    # cp out/klipper.bin ../klipper_config/
    # rename : firmware.bin
    ##---------------------------------------------------------------------##
    # The configuration is very specific for heavily modified VORON V-2.4r2.
    # Use it as reference.
    
    # RS, 2022 - LDO Motors VORON V2.4r2, BIGTREETECH Octopus Pro V1.0 STM32F446
##===========================================================================

##===========================================================================
##================================== Files ==================================
##===========================================================================
[include variables.cfg]
[include steppers.cfg]
# [include resonance-tester.cfg]
[include extruders.cfg]
[include firmware-retraction.cfg]
[include heaters.cfg]
[include sensors.cfg]
[include probe.cfg]
[include homing-override.cfg]
[include quad-gantry-level.cfg]
[include bed-mesh.cfg]
[include fans.cfg]
[include lights.cfg]
[include display.cfg]
[include menu.cfg]
[include macros.cfg]
[include miscellaneous.cfg]
[include timelapse.cfg]

[include macros/probe/probe-macros.cfg]
[include macros/probe/probe-dock.cfg]
[include macros/probe/probe-calibrate.cfg]
[include macros/probe/probe-attach.cfg]
[include macros/probe/probe-accuracy.cfg]

[include macros/profiles/print-profiles.cfg]

[include macros/progress/print-start.cfg]
[include macros/progress/print-end.cfg]
[include macros/progress/prime-line.cfg]
[include macros/progress/pause-resume.cfg]

[include macros/tools/wipe-nozzle.cfg]
[include macros/tools/pre-heat.cfg]
[include macros/tools/park-toolhead.cfg]
[include macros/tools/filament-purge.cfg]
[include macros/tools/filament-load-unload.cfg]
[include macros/tools/filament-change.cfg]
[include macros/tools/debug.cfg]
[include macros/tools/clean-nozzle.cfg]
[include macros/tools/center-front.cfg]
[include macros/tools/belt_tension.cfg]

# [include macros/tuning/test-speed.cfg]
[include macros/tuning/test-accel.cfg]
[include macros/tuning/retraction.cfg]
[include macros/tuning/pressure-advance.cfg]
[include macros/tuning/input-shaping.cfg]

##===========================================================================
##============================ MCU Configuration ============================
##===========================================================================
##----------------- BIGTREETECH Octopus Pro V1.0, STM32F446 -----------------
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_130047000A50534E4E313120-if00
restart_method: command
##----------------------- RaspberryPi 4b, 4GB RAM, UK -----------------------
[mcu rpi]
serial: /tmp/klipper_host_mcu
##-------------------------------- EBB36 CAN --------------------------------
[mcu canbus]
canbus_uuid: 1f4508707061

##===========================================================================
##========================== Printer Configuration ==========================
##===========================================================================
[printer]
kinematics: corexy
max_velocity: 520      # Max 1000
max_accel: 10000        # Max 65000
max_z_velocity: 20
max_z_accel: 500
# max_accel_to_decel: 30000
square_corner_velocity: 9.0

[input_shaper]
shaper_freq_x: 62.4  # Max Acceleration : 11500
shaper_type_x: mzv
shaper_freq_y: 42.0  # Max Acceleration : 5200
shaper_type_y: mzv
##--------------------------------- Commands --------------------------------
[gcode_macro _PRINTER_RESET]
gcode:
    {% set velocity = printer.configfile.settings["printer"].max_velocity|int %}
    {% set accel = printer.configfile.settings["printer"].max_accel|int %}
    {% set accel_to_decel = printer.configfile.settings["printer"].max_accel_to_decel|int %}
    {% set scv = printer.configfile.settings["printer"].square_corner_velocity|float %}


    _TEXT MSG="Printer reset" OUTPUT_TARGET=0

    G90
    G92 E0.0
    M220 S100
    M221 S100

    SET_VELOCITY_LIMIT VELOCITY={velocity}
    SET_VELOCITY_LIMIT ACCEL={accel}
    SET_VELOCITY_LIMIT ACCEL_TO_DECEL={accel_to_decel}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={scv}

    BED_MESH_CLEAR

    SET_GCODE_OFFSET Z=0
    M107
    _TEXT MSG="VORON-2.4" OUTPUT_TARGET=2
##=================================== End ===================================

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh ZERO]
#*# version = 1
#*# points =
#*# 	0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000
#*# 	0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000
#*# 	0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000
#*# 	0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000
#*# 	0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000
#*# 	0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000
#*# 	0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000
#*# 	0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000
#*# 	0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.1
#*# min_x = 10.0
#*# max_x = 340.0
#*# min_y = 22.0
#*# max_y = 330.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.193125, 0.129063, 0.092188, 0.088438, 0.101563, 0.096250, 0.107813, 0.134688, 0.176563
#*# 	  0.224688, 0.107500, 0.069688, 0.061250, 0.070625, 0.083750, 0.091250, 0.115625, 0.163125
#*# 	  0.225313, 0.109375, 0.049375, 0.038438, 0.041250, 0.035313, 0.051250, 0.075000, 0.106875
#*# 	  0.178125, 0.101563, 0.001875, 0.001875, -0.000312, 0.014063, 0.021250, 0.034063, 0.070313
#*# 	  0.105313, 0.105625, -0.002812, 0.000625, 0.000000, 0.008750, 0.008125, 0.014375, 0.069375
#*# 	  0.099375, 0.040312, 0.012187, -0.010313, -0.009063, 0.003750, 0.014062, 0.033437, 0.069687
#*# 	  0.121250, 0.051562, 0.024062, 0.011875, 0.015312, 0.016250, 0.025937, 0.035000, 0.104687
#*# 	  0.227187, 0.080937, 0.065000, 0.048750, 0.065625, 0.066875, 0.085312, 0.089375, 0.140312
#*# 	  0.273750, 0.144062, 0.102187, 0.093750, 0.112500, 0.129375, 0.403437, 0.365937, 0.202187
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.1
#*# min_x = 10.0
#*# max_x = 340.0
#*# min_y = 22.0
#*# max_y = 330.0
