##===========================================================================
##========================== Printer Configuration ==========================
##============================== ANNEX Engineering, K3 ==============================
##===========================================================================

    # |------------------------|
    # |        BACKPACK        |
    # |------------------------|
    # | Y  |    | Z1 |    | X1 |
    # |-----    ------    -----|
    # |                        |
    # | ------          ------ |
    # | | Z  |          | Z2 | |
    # | ------          ------ |
    # |-----              -----|
    # | X  |              | Y1 |
    # |------------------------|

    # This file contains common pin mappings for the FYSETC Spider Controller
    # To use this config, the firmware should be compiled for the
    # STM32F446.

    # use the following modifiers before the pin definition (ex: ^!ar99)
    # ! 			invert the logic
    # ^ 			activate 5v pullup (does not apply to all pins)
    # mcu_name: 	use pins on additional MCU (ex: z:ar10)

    # The "make flash" command does not work on the FYSETC Spider. Instead,
    # after running "make", copy the generated "out/klipper.bin" file to a
    # file named "firmware.bin" on an SD card and then restart the FYSETC 
    # Spider with SD card inserted.
    ##---------------------------------------------------------------------##
    # sudo apt install make
    # cd ~/klipper
    # make clean
    # make menuconfig
        # [V] Enable extra low-level
        # Micro-controller architecture : STMicroelectronics STM32
        # Processor : STM32F446
        # Bootloader : 32KiB bootloader
        # Clock Reference : 12 MHz crystal
        # Connection : USB (on PA11/PA12)
        # [Q] - Save and Exit
    # make
    # cd ~/klipper
    # cp out/klipper.bin ../klipper_config/
    # rename : firmware.bin
    ##---------------------------------------------------------------------##
    # The configuration is very specific for heavily modified VORON V-2.4r2.
    # Use it as reference.
    
    # RS, 2023 - ANNEX Engineering, FYSETC Spider

# Solving mcu 'mcu': Unable to connect
# apt show udev
# cd ~;wget http://ftp.us.debian.org/debian/pool/main/s/systemd/libudev1_252.5-2~bpo11+1_`dpkg --print-architecture`.deb http://ftp.us.debian.org/debian/pool/main/s/systemd/udev_252.5-2~bpo11+1_`dpkg --print-architecture`.deb;APT_LISTCHANGES_FRONTEND=none sudo apt install --fix-broken ./libudev1_252.5-2~bpo11+1_`dpkg --print-architecture`.deb ./udev_252.5-2~bpo11+1_`dpkg --print-architecture`.deb; rm libudev1_252.5-2~bpo11+1_`dpkg --print-architecture`.deb udev_252.5-2~bpo11+1_`dpkg --print-architecture`.deb
##===========================================================================

##===========================================================================
##================================== Files ==================================
##===========================================================================
[include variables.cfg]
[include steppers.cfg]
# [include resonance-tester.cfg]
[include extruders.cfg]
[include firmware-retraction.cfg]
[include heaters.cfg]
[include sensors.cfg]
[include beacon.cfg]
[include homing-override.cfg]
[include quad-gantry-level.cfg]
[include bed-mesh.cfg]
[include fans.cfg]
[include lights.cfg]
[include display.cfg]
[include menu.cfg]
[include macros.cfg]
[include miscellaneous.cfg]
# [include timelapse.cfg]

[include macros/profiles/print-profiles.cfg]

[include macros/progress/print-start.cfg]
[include macros/progress/print-end.cfg]
[include macros/progress/prime-line.cfg]
[include macros/progress/pause-resume.cfg]

[include macros/tools/wipe-nozzle.cfg]
[include macros/tools/park-toolhead.cfg]
[include macros/tools/filament-purge.cfg]
[include macros/tools/filament-load-unload.cfg]
[include macros/tools/filament-change.cfg]
[include macros/tools/debug.cfg]
[include macros/tools/clean-nozzle.cfg]
[include macros/tools/center-front.cfg]
[include macros/tools/belt_tension.cfg]

[include macros/tuning/test-speed.cfg]
[include macros/tuning/test-accel.cfg]
[include macros/tuning/retraction.cfg]

##===========================================================================
##============================ MCU Configuration ============================
##===========================================================================
# ls /dev/serial/by-id/*
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_180009001950563046363120-if00
restart_method: command

[mcu supernova]
serial: /dev/serial/by-id/usb-Klipper_rp2040_E660C062136E362B-if00

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC9, EXP1_2=PA8,
    EXP1_3=PC11, EXP1_4=PD2,
    EXP1_5=PC10, EXP1_6=PC12,    # Slot in the socket on this side
    EXP1_7=PD0, EXP1_8=PD1,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PC6, EXP2_4=PA4,
    EXP2_5=PC7, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PB10, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

##===========================================================================
##========================== Printer Configuration ==========================
##===========================================================================
[printer]
kinematics: cartesian
max_velocity: 300  #1000
max_accel: 12000
max_z_velocity: 10  #20
max_z_accel: 500  #1000
square_corner_velocity: 8.0  #12

[input_shaper]
shaper_freq_x: 77.2
shaper_type_x: zv
damping_ratio_x: 0.0518
shaper_freq_y: 71.8
shaper_type_y: zv
damping_ratio_y: 0.0470
##--------------------------------- Commands --------------------------------
[gcode_macro _PRINTER_RESET]
gcode:
    {% set velocity = printer.configfile.settings["printer"].max_velocity|int %}
    {% set accel = printer.configfile.settings["printer"].max_accel|int %}
    {% set accel_to_decel = printer.configfile.settings["printer"].max_accel_to_decel|int %}
    {% set scv = printer.configfile.settings["printer"].square_corner_velocity|float %}


    _TEXT MSG="Printer reset" OUTPUT_TARGET=0

    G90
    G92 E0.0
    M220 S100
    M221 S100

    SET_VELOCITY_LIMIT VELOCITY={velocity}
    SET_VELOCITY_LIMIT ACCEL={accel}
    SET_VELOCITY_LIMIT ACCEL_TO_DECEL={accel_to_decel}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={scv}

    BED_MESH_CLEAR

    SET_GCODE_OFFSET Z=0
    M107
    # _TEXT MSG="VORON-2.4" OUTPUT_TARGET=2
##=================================== End ===================================

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.572340059466209,
#*# 	  1.890410429443088,
#*# 	  0.7393296240360324,
#*# 	  0.3556585038746895,
#*# 	  0.2780576850724088,
#*# 	  0.16453548599698847,
#*# 	  -0.13440353425060175,
#*# 	  -0.09331962186844585,
#*# 	  0.1468088777707621,
#*# 	  0.08653812515782229
#*# model_domain = 3.2758833231244935e-07,3.354758635411781e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 50.875299
#*# model_offset = 0.00000
