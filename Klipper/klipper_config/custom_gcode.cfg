##===========================================================================
##=============================== Print Start ===============================
##===========================================================================
    # Replace SuperSlicer's custom g-code scripts with
    # PRINT_START
##===========================================================================
[gcode_macro PRINT_START]
variable_parameter_FILAMENT_TYPE : "Stock"
gcode:
    {% set BED_TEMPERATURE = params.BED_TEMPERATURE %}
    {% set EXTRUDER_TEMPERATURE = params.EXTRUDER_TEMPERATURE %}
    # Initialize
    #BEEP
    PRINT MSG="Initializing" OUTPUT_TARGET=1
    CLEAR_PAUSE
    # Turn-off fan
    M107
    # Units to milimeters
    G21
    # Set absolute coordinates
    G90
    # Set relative extrusion distances
    M83
    # Reset extrusion rate
    M221 S100
    # Reset feed rate
    M220 S100
    # Set filament profile
    SET_FILAMENT_PROFILE TYPE={params.FILAMENT_TYPE|default("Stock")}
##--------------------------- Temperature Check I ---------------------------
##--------------------------------- Pre-heat --------------------------------
    PRINT MSG="Temperature Check I" OUTPUT_TARGET=1
    # Start heating "BED": final temp., "EXTRUDER": pre-heat temp.
    M140 S{BED_TEMPERATURE}
    M104 S150
##----------------------------- Bed Temperature -----------------------------
    # Wait "BED" final temperature
    M190 S{BED_TEMPERATURE}
##--------------------------------- Extruder --------------------------------
    {% if printer.extruder.temperature < 150 %}
        # Wait "EXTRUDER" pre-heat temperature
        M109 S150
    {% endif %}
##--------------------------- Homing & Auto-Align ---------------------------
    #BEEP
    PRINT MSG="Homing & Auto-Align" OUTPUT_TARGET=1
    # Home all axes
    G28
    # Auto-align
    Z_TILT_ADJUST
    # Home Z
    G28 Z
##--------------------------- Temperature Check II --------------------------
##--------------------------------- Pre-heat --------------------------------
    PRINT MSG="Temperature Check II" OUTPUT_TARGET=1
    # Start heating "BED": final temp., "EXTRUDER": pre-heat temp.
    M140 S{BED_TEMPERATURE}
    M104 S150
##----------------------------- Bed Temperature -----------------------------
    # Wait "BED" final temperature
    M190 S{BED_TEMPERATURE}
##--------------------------------- Extruder --------------------------------
    {% if printer.extruder.temperature < 150 %}
        # Wait "EXTRUDER" pre-heat temperature
        M109 S150
    {% endif %}
##----------------------------------- ABL -----------------------------------
    #BEEP
    PRINT MSG="Initialize Bed Mesh" OUTPUT_TARGET=1
    # Home Z
    G28 Z
    # Area print mesh calibrate
    BED_MESH_CALIBRATE PRINT_MIN={params.PRINT_MIN} PRINT_MAX={params.PRINT_MAX} FORCE_NEW_MESH=True
    G1 X0 Y0 F18000
##-------------------------- Temperature Check III --------------------------
##---------------------------- Final Temperature ----------------------------
    PRINT MSG="Final Temperature" OUTPUT_TARGET=1
    # Start heating "BED" "EXTRUDER" final temperature
    M140 S{BED_TEMPERATURE}
    M104 S{EXTRUDER_TEMPERATURE}
    # Wait "BED" "EXTRUDER" final temperature
    M190 S{BED_TEMPERATURE}
    M109 S{EXTRUDER_TEMPERATURE}
##-------------------------------- Prime Line -------------------------------
    PRINT_PRIME_LINE
##-------------------------------- Printing ---------------------------------
    PRINT MSG="Printing..." OUTPUT_TARGET=1
    # Set absolute coordinates
    G90
    # Set relative extrusion distances
    M83
    # Reset extrusion distance
    G92 E0.0
##=================================== End ===================================

##===========================================================================
##================================ Prime Line ===============================
##===========================================================================
[gcode_macro PRINT_PRIME_LINE]
gcode:
    #BEEP
    PRINT MSG="Prime Line" OUTPUT_TARGET=1
    # Set absolute coordinates
    G90
    # Set relative extrusion distances
    M83
    # Reset extrusion distance
    G92 E0
    # Move to start Line 1
    G1 X0 Y0 F9000
    G1 Z0.28 F120
    # Purge
    G4 P100
    G1 E1 F1800
    # Line 1
    G1 X80 E6 F1500
    # Reset extrusion distance
    G92 E0
    # Line 2
    G1 X110 E3 F1000
##------------------------------- Wipe Action -------------------------------
    # Set relative coordinates
    G91
    # Wipe
    G1 X-0.5 Y-0.5 F18000
    G1 X0.5 Y0.5 F18000
    # Set absolute coordinates
    G90
    # Reset extrusion distance
    G92 E0
    # Wait
    G4 P100
##=================================== End ===================================

##===========================================================================
##================================ Print End ================================
##===========================================================================
    # Replace SuperSlicer's custom g-code scripts with
    # PRINT_END
##===========================================================================
[gcode_macro PRINT_END]
gcode:
    #BEEP
    PRINT MSG="Done" OUTPUT_TARGET=1
    # Reset machine limit
    SET_VELOCITY_LIMIT VELOCITY=300
    SET_VELOCITY_LIMIT ACCEL=4500
    SET_VELOCITY_LIMIT ACCEL_TO_DECEL=2250
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=10
    # Set relative coordinates
    G91
    # Retract & wipe
    G1 E-1 F1800
    G1 X-1 Y-1 F18000
    G1 X1 Y1 F18000
    # Turn off fan & temperatures
    TURN_OFF_HEATERS
    M106 S0
    # Set absolute coordinates
    G90
    # Set maximum & actual axes
    {% set max_x = printer.toolhead.axis_maximum.x|float %}
    {% set max_y = printer.toolhead.axis_maximum.y|float %}
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set end_x = max_x %}
    {% set end_y = max_y * 0.9 %}
    {% set end_z = act_z + 0.2 %}
    {% set end_z1 = act_z + 100 %}
    # Move Z axis
    {% if act_z < max_z %}
        G1 Z{end_z} F600
    {% else %}
        G1 Z{act_z} F600
    {% endif %}
    # Present print
    G1 X{end_print_x} F9000
    G1 Y{end_print_y} F9000
    # Move further Z axis
    {% if act_z < 100 %}
        G1 Z{end_z1} F600
    {% else %}
        G1 Z{act_z} F600
    {% endif %}
    # Disable motors
    M84
    # Clear Mesh
    BED_MESH_CLEAR
    # Reset extrusion rate
    M221 S100
    # Reset feed rate
    M220 S100
##=================================== End ===================================

##===========================================================================
##=============================== Print Cancel ==============================
##===========================================================================
    # Replace SuperSlicer's custom g-code scripts with
    # PRINT_CANCEL
##===========================================================================
[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
    #BEEP
    PRINT MSG="Done" OUTPUT_TARGET=1
    # Reset machine limit
    SET_VELOCITY_LIMIT VELOCITY=300
    SET_VELOCITY_LIMIT ACCEL=4500
    SET_VELOCITY_LIMIT ACCEL_TO_DECEL=2250
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=10
    # Set relative coordinates
    G91
    # Retract & wipe
    G1 E-1 F1800
    G1 X-1 Y-1 F18000
    G1 X1 Y1 F18000
    # Turn off fan & temperatures
    TURN_OFF_HEATERS
    M106 S0
    # Set absolute coordinates
    G90
    # Set maximum & actual axes
    {% set max_x = printer.toolhead.axis_maximum.x|float %}
    {% set max_y = printer.toolhead.axis_maximum.y|float %}
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set end_x = max_x %}
    {% set end_y = max_y * 0.9 %}
    {% set end_z = act_z + 0.2 %}
    {% set end_z1 = act_z + 100 %}
    # Move Z axis
    {% if act_z < max_z %}
        G1 Z{end_z} F600
    {% else %}
        G1 Z{act_z} F600
    {% endif %}
    # Present print
    G1 X{end_print_x} F9000
    G1 Y{end_print_y} F9000
    # Move further Z axis
    {% if act_z < 100 %}
        G1 Z{end_z1} F600
    {% else %}
        G1 Z{act_z} F600
    {% endif %}
    # Disable motors
    M84
    # Clear Mesh
    BED_MESH_CLEAR
    # Reset extrusion rate
    M221 S100
    # Reset feed rate
    M220 S100
##=================================== End ===================================